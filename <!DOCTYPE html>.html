<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Car Repair Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .instruction-box {
            min-height: 200px;
            max-height: 70vh;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .source-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
                <span class="text-blue-600">AI</span> Mechanic Assistant
            </h1>
            <p class="text-gray-500">Get grounded, step-by-step instructions for any car repair.</p>
        </header>

        <main class="bg-white p-6 md:p-8 rounded-xl shadow-2xl">
            <section id="input-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Year Input -->
                    <div>
                        <label for="carYear" class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                        <input type="number" id="carYear" min="1950" max="2025" placeholder="e.g., 2018"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                               required>
                    </div>

                    <!-- Make Input -->
                    <div>
                        <label for="carMake" class="block text-sm font-medium text-gray-700 mb-1">Make</label>
                        <input type="text" id="carMake" placeholder="e.g., Toyota"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                               required>
                    </div>

                    <!-- Model Input -->
                    <div>
                        <label for="carModel" class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                        <input type="text" id="carModel" placeholder="e.g., Camry"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                               required>
                    </div>
                </div>

                <!-- Part Input -->
                <div>
                    <label for="partToFix" class="block text-sm font-medium text-gray-700 mb-1">Part to Fix/Replace</label>
                    <input type="text" id="partToFix" placeholder="e.g., front brake pads, alternator, timing belt"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                           required>
                </div>

                <button id="generateButton" onclick="getInstructions()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-[1.005]">
                    Get Repair Instructions
                </button>
            </section>

            <section id="results-container" class="mt-8 pt-6 border-t border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Repair Guide</h2>

                <div id="loadingIndicator" class="hidden text-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="mt-3 text-blue-600 font-medium">Searching repair manuals and tutorials...</p>
                </div>

                <!-- Instruction Display -->
                <div id="instructionsOutput" class="instruction-box bg-gray-50 p-4 rounded-lg border border-gray-200 text-gray-800 text-sm">
                    <p class="text-gray-500 italic">Enter your vehicle and part details above to generate the repair steps.</p>
                </div>

                <!-- Sources Display -->
                <div id="sourcesOutput" class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg hidden">
                    <h3 class="font-semibold text-sm text-yellow-800 mb-2">Sources</h3>
                    <ul id="sourcesList" class="list-disc ml-5 text-xs text-yellow-700 space-y-1">
                        <!-- Sources will be inserted here -->
                    </ul>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- API & Firebase Setup ---
        const apiKey = ""; // API key will be provided automatically in the canvas environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- Core Functions ---

        /**
         * Retries a fetch request with exponential backoff.
         * @param {string} url - The API endpoint URL.
         * @param {object} options - The fetch options (method, headers, body).
         * @param {number} retries - The number of remaining retries.
         */
        async function fetchWithRetry(url, options, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < retries - 1) {
                        // Too Many Requests, wait and retry
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) {
                        console.error("Fetch failed after multiple retries:", error);
                        throw error;
                    }
                }
            }
        }

        /**
         * Fetches repair instructions from the Gemini API.
         */
        async function getInstructions() {
            const carYear = document.getElementById('carYear').value.trim();
            const carMake = document.getElementById('carMake').value.trim();
            const carModel = document.getElementById('carModel').value.trim();
            const partToFix = document.getElementById('partToFix').value.trim();
            const instructionsOutput = document.getElementById('instructionsOutput');
            const sourcesOutput = document.getElementById('sourcesOutput');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const generateButton = document.getElementById('generateButton');

            if (!carYear || !carMake || !carModel || !partToFix) {
                instructionsOutput.innerHTML = `<p class="text-red-500 font-semibold">Please fill in all vehicle and part details.</p>`;
                sourcesOutput.classList.add('hidden');
                return;
            }

            // UI State: Loading
            generateButton.disabled = true;
            generateButton.innerHTML = 'Searching...';
            loadingIndicator.classList.remove('hidden');
            instructionsOutput.innerHTML = '';
            sourcesOutput.classList.add('hidden');

            const userQuery = `Provide the tool list and detailed, numbered steps for replacing the ${partToFix} on a ${carYear} ${carMake} ${carModel}. Focus on clarity, safety, and conciseness.`;

            const systemPrompt = `You are a professional automotive technician and clear instructional writer. Your task is to provide concise, easy-to-follow, step-by-step instructions for performing a specific car repair. Structure the response clearly, starting with a 'Tools Required' section (a simple list) followed by 'Step-by-Step Procedure' (a numbered list). Do not include any conversational preamble, safety warnings, or lengthy explanations unless it is a necessary part of the first step. Focus only on the tools required and the procedural steps.`;


            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];

                    // 1. Extract and display the generated text
                    instructionsOutput.innerHTML = formatInstructions(text);

                    // 2. Extract and display grounding sources (citations)
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);

                        displaySources(sources);
                    }

                } else {
                    instructionsOutput.innerHTML = `<p class="text-red-500 font-semibold">Could not find repair instructions. Please try a different part or vehicle combination.</p>`;
                }

            } catch (error) {
                console.error("API Call failed:", error);
                instructionsOutput.innerHTML = `<p class="text-red-500 font-semibold">An error occurred while fetching instructions. Please check your network connection.</p>`;
            } finally {
                // UI State: Done
                loadingIndicator.classList.add('hidden');
                generateButton.disabled = false;
                generateButton.innerHTML = 'Get Repair Instructions';
            }
        }

        /**
         * Simple function to format text for better display (e.g., handles bullet points and numbered lists).
         * @param {string} text - The raw text output from the API.
         * @returns {string} The HTML formatted text.
         */
        function formatInstructions(text) {
            // Replace markdown-style lists/steps with HTML structures
            let html = text.replace(/^\s*\*/gm, (match) => 'â€¢').replace(/^\s*(\d+)\./gm, (match, p1) => `${p1}.`);
            // Wrap in <pre> tags to preserve whitespace/line breaks and ensure numbered steps look correct
            return `<pre class="text-sm leading-relaxed">${html}</pre>`;
        }

        /**
         * Displays the list of grounding sources.
         * @param {Array<Object>} sources - Array of source objects {uri, title}.
         */
        function displaySources(sources) {
            const sourcesList = document.getElementById('sourcesList');
            const sourcesOutput = document.getElementById('sourcesOutput');

            if (sources.length > 0) {
                sourcesList.innerHTML = sources.map(source =>
                    `<li><a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="source-link hover:text-blue-600 transition">${source.title || source.uri}</a></li>`
                ).join('');
                sourcesOutput.classList.remove('hidden');
            } else {
                sourcesOutput.classList.add('hidden');
            }
        }

        // Attach event listener to the button
        document.getElementById('generateButton').addEventListener('click', getInstructions);

    </script>
</body>
</html>
